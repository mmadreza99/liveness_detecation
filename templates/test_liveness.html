<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liveness Detection</title>
    <style>
        body {
            font-family: Tahoma, Arial, sans-serif;
            text-align: center;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        video {
            width: 100%;
            max-width: 400px;
            height: auto;
            border: 2px solid #3498db;
            border-radius: 8px;
            margin: 10px auto;
            display: block;
        }
        .info-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: right;
        }
        .status-section {
            margin: 20px 0;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px;
            background: #f1f8ff;
            border-radius: 5px;
        }
        .status-label {
            font-weight: bold;
            color: #2c3e50;
        }
        .status-value {
            color: #34495e;
        }
        #instruction {
            font-size: 18px;
            margin: 20px;
            color: #e74c3c;
            font-weight: bold;
            min-height: 30px;
        }
        #countdown {
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
            margin: 15px 0;
        }
        button {
            padding: 12px 25px;
            margin: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #startBtn {
            background: #27ae60;
            color: white;
        }
        #startBtn:hover {
            background: #219a52;
        }
        #resetBtn {
            background: #e74c3c;
            color: white;
        }
        #resetBtn:hover {
            background: #c0392b;
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .processing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>تشخیص زنده‌بودن (Liveness Detection)</h1>

    <div class="info-panel">
        <div class="status-item">
            <span class="status-label">وضعیت دوربین:</span>
            <span class="status-value" id="cameraStatus">غیرفعال</span>
        </div>
    </div>

    <video id="video" autoplay playsinline></video>
    <div id="countdown"></div>
    <div id="instruction">برای شروع دکمه زیر را فشار دهید</div>

    <div class="status-section">
        <div class="status-item">
            <span class="status-label">وضعیت چالش:</span>
            <span class="status-value" id="challengeStatus">آماده</span>
        </div>
        <div class="status-item">
            <span class="status-label">پیشرفت:</span>
            <span class="status-value" id="progressStatus">0%</span>
        </div>
    </div>

    <div id="resultContainer"></div>

    <button id="startBtn">شروع تشخیص زنده‌بودن</button>
    <button id="resetBtn" disabled>بازنشانی</button>
</div>

<script>
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const instructionDiv = document.getElementById('instruction');
    const countdownDiv = document.getElementById('countdown');
    const resultContainer = document.getElementById('resultContainer');
    const cameraStatus = document.getElementById('cameraStatus');
    const challengeStatus = document.getElementById('challengeStatus');
    const progressStatus = document.getElementById('progressStatus');

    let stream;
    let intervalId;
    let countdownInterval;
    let remainingTime = 10;
    const canvas = document.createElement('canvas');

    // Start webcam
    async function startWebcam() {
        try {
            cameraStatus.textContent = "در حال راه‌اندازی...";
            stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
            video.srcObject = stream;
            cameraStatus.textContent = "فعال";
            return true;
        } catch (err) {
            console.error("Error accessing webcam:", err);
            cameraStatus.textContent = "خطا در دسترسی";
            showResult("خطا در دسترسی به دوربین. لطفا مجوزها را بررسی کنید.", "error");
            return false;
        }
    }

    // Stop everything
    function stopLiveness() {
        if (stream) stream.getTracks().forEach(track => track.stop());
        if (intervalId) clearInterval(intervalId);
        if (countdownInterval) clearInterval(countdownInterval);
        video.srcObject = null;
        instructionDiv.textContent = "برای شروع دکمه زیر را فشار دهید";
        countdownDiv.textContent = "";
        challengeStatus.textContent = "آماده";
        progressStatus.textContent = "0%";
        cameraStatus.textContent = "غیرفعال";
        startBtn.disabled = false;
        resetBtn.disabled = true;
        const response = fetch('/reset_attempts/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ get_instruction: true })
            });

    }

    // Stop everything
    function no_time() {
        if (stream) stream.getTracks().forEach(track => track.stop());
        if (intervalId) clearInterval(intervalId);
        if (countdownInterval) clearInterval(countdownInterval);
        video.srcObject = null;
        instructionDiv.textContent = "برای شروع دکمه زیر را فشار دهید";
        countdownDiv.textContent = "";
        challengeStatus.textContent = "آماده";
        progressStatus.textContent = "0%";
        cameraStatus.textContent = "غیرفعال";
        startBtn.disabled = false;
        resetBtn.disabled = true;
        const response = fetch('/reset_attempts/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ get_instruction: true })
            });

    }

    // Countdown update
    function updateCountdown() {
        countdownDiv.textContent = `زمان باقی‌مانده: ${remainingTime} ثانیه`;
        remainingTime--;
        if (remainingTime < 0) {
            clearInterval(countdownInterval);
            countdownDiv.textContent = "زمان به پایان رسید!";
        }
    }

    // Show result
    function showResult(message, type) {
        resultContainer.innerHTML = `<div class="result ${type}">${message}</div>`;
    }

    // Get random instruction from server
    async function getInstruction() {
        try {
            const response = await fetch('/check_frame/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ get_instruction: true })
            });
            const data = await response.json();
            instructionDiv.textContent = data.instruction || "دستور موجود نیست";
            return data.instruction;
        } catch (err) {
            console.error("Error fetching instruction:", err);
            instructionDiv.textContent = "خطا در بارگذاری دستور";
            return null;
        }
    }

    // Send frames periodically
    function startSendingFrames() {
        intervalId = setInterval(async () => {
            if (!video.videoWidth || !video.videoHeight) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const imgData = canvas.toDataURL('image/jpeg');

            try {
                const resp = await fetch('/check_frame/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imgData })
                });
                const resData = await resp.json();

                if (resData.status && resData.status !== "Processing...") {
                    challengeStatus.textContent = resData.status.includes("Alive") ? "موفق" : "ناموفق";
                    if (resData.status.includes("Alive")) {
                        showResult("✅ چالش با موفقیت انجام شد", "success");
                        stopLiveness();
                    } else {
                        stopLiveness();
                        showResult("⚠️ چالش انجام نشد، لطفا دوباره تلاش کنید", "error");
                    }
                } else {
                    challengeStatus.textContent = "در حال پردازش...";
                    showResult("در حال تشخیص زنده‌بودن... لطفا دستور را دنبال کنید", "processing");
                }

                const progress = Math.min(100, Math.max(0, 100 - (remainingTime * 10)));
                progressStatus.textContent = `${progress}%`;

                if (resData.new_instruction) {
                    instructionDiv.textContent = resData.new_instruction;
                }
            } catch (err) {
                console.error("Error sending frame:", err);
                showResult("خطا در ارسال داده به سرور", "error");
            }
        }, 1000);
    }

    // Start button
    startBtn.addEventListener('click', async () => {
        startBtn.disabled = true;
        resetBtn.disabled = false;

        const webcamStarted = await startWebcam();
        if (!webcamStarted) {
            startBtn.disabled = false;
            return;
        }

        const instruction = await getInstruction();
        if (!instruction) {
            startBtn.disabled = false;
            return;
        }

        remainingTime = 10;
        updateCountdown();
        countdownInterval = setInterval(updateCountdown, 1000);
        startSendingFrames();
    });

    // Reset button
    resetBtn.addEventListener('click', () => {
        stopLiveness();
        getInstruction();
        resultContainer.innerHTML = "";
    });
</script>
</body>
</html>
