<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liveness Detection</title>
    <style>
        body {
            font-family: Tahoma, Arial, sans-serif;
            text-align: center;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        video {
            width: 100%;
            max-width: 460px;
            height: auto;
            border: 2px solid #3498db;
            border-radius: 8px;
            margin: 10px auto;
            display: block;
        }
        .info-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: right;
        }
        .status-section {
            margin: 20px 0;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px;
            background: #f1f8ff;
            border-radius: 5px;
        }
        .status-label {
            font-weight: bold;
            color: #2c3e50;
        }
        .status-value {
            color: #34495e;
        }
        #instruction {
            font-size: 18px;
            margin: 20px;
            color: #e74c3c;
            font-weight: bold;
            min-height: 30px;
        }
        #countdown {
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
            margin: 15px 0;
        }
        button {
            padding: 12px 25px;
            margin: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #startBtn {
            background: #27ae60;
            color: white;
        }
        #startBtn:hover {
            background: #219a52;
        }
        #resetBtn {
            background: #e74c3c;
            color: white;
        }
        #resetBtn:hover {
            background: #c0392b;
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .video-container {
            position: relative;
            display: inline-block;
            max-width: 460px; /* حداکثر اندازه برای دسکتاپ */
            margin: 0 auto;
        }
        #instruction-overlay {
            position: absolute;
            top: 15px; /* فاصله از بالا تصویر */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.34);
            color: #950000;
            padding: 8px 20px;
            border-radius: 4px;
            font-size: 15px;
            font-weight: normal;
            pointer-events: none; /* جلوگیری از تداخل کلیک */
            width: 90%; /* در صفحه‌های کوچک، متن جمع‌وجور میشه */
        }
        video {
            width: 100%;
            height: auto;
            aspect-ratio: 3/4; /* حفظ نسبت ارتفاع به عرض، مخصوصاً در موبایل‌ها */
            border: 2px solid #3498db;
            border-radius: 8px;
            display: block;
        }
         .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
         .processing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
         }
        /* برای صفحه‌های خیلی کوچک (موبایل‌ها) */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            #instruction-overlay {
                font-size: 14px;
                bottom: 5px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>احراز هویت (Liveness Detection)</h1>

    <div class="info-panel">
        <div class="status-item">
            <span class="status-label">وضعیت دوربین:</span>
            <span class="status-value" id="cameraStatus">غیرفعال</span>
        </div>
    </div>

    <div class="video-container">
        <video id="video" autoplay playsinline></video>
        <div id="instruction-overlay">برای شروع دکمه زیر را فشار دهید</div>
    </div>
    <div id="countdown"></div>

    <div class="status-section">
        <div class="status-item">
            <span class="status-label">وضعیت چالش:</span>
            <span class="status-value" id="challengeStatus">آماده</span>
        </div>
        <div class="status-item">
            <span class="status-label">پیشرفت:</span>
            <span class="status-value" id="progressStatus">0%</span>
        </div>
    </div>

    <div id="resultContainer"></div>

    <button id="startBtn">شروع تشخیص زنده‌بودن</button>
    <button id="resetBtn" disabled>بازنشانی</button>
</div>

<script>
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const instructionDiv = document.getElementById('instruction');
    const countdownDiv = document.getElementById('countdown');
    const resultContainer = document.getElementById('resultContainer');
    const cameraStatus = document.getElementById('cameraStatus');
    const challengeStatus = document.getElementById('challengeStatus');
    const progressStatus = document.getElementById('progressStatus');
    const instructionOverlay = document.getElementById('instruction-overlay');

    let currentNonce = null;
    let expiresAt = null;
    let stream;              // ✅ Shared audio+video stream
    let intervalId;
    let countdownInterval;
    let remainingTime = 10;
    const canvas = document.createElement('canvas');

    // Start webcam
    async function startWebcam() {
        try {
            cameraStatus.textContent = "در حال راه‌اندازی...";
            stream = await navigator.mediaDevices.getUserMedia({ video: { width: 460, height: 640 } });
            video.srcObject = stream;
            cameraStatus.textContent = "فعال";
            return true;
        } catch (err) {
            console.error("Error accessing webcam:", err);
            cameraStatus.textContent = "خطا در دسترسی";
            showResult("خطا در دسترسی به دوربین. لطفا مجوزها را بررسی کنید.", "error");
            return false;
        }
    }

    // Stop everything
    function stopLiveness(challenges_status=null ) {
        if (stream) stream.getTracks().forEach(track => track.stop());
        if (intervalId) clearInterval(intervalId);
        if (countdownInterval) clearInterval(countdownInterval);
        video.srcObject = null;
        {#instructionDiv.textContent = "برای شروع دکمه زیر را فشار دهید";#}
        countdownDiv.textContent = "";
        challengeStatus.textContent = challenges_status || "آماده";
        progressStatus.textContent = "0%";
        cameraStatus.textContent = "غیرفعال";
        startBtn.disabled = false;
        resetBtn.disabled = true;
        fetch('/reset_attempts/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nonce: currentNonce })
        });
    }

    // ✅ Countdown update
    function updateCountdown() {
        countdownDiv.textContent = `زمان باقی‌مانده: ${remainingTime} ثانیه`;
        remainingTime--;
        if (remainingTime < 0) {
            clearInterval(countdownInterval);
            countdownDiv.textContent = "زمان به پایان رسید!";
        }
    }

    // Show result
    function showResult(message, type) {
        resultContainer.innerHTML = `<div class="result ${type}">${message}</div>`;
    }

    // Get random instruction from server
    async function getInstruction() {
        try {
            const response = await fetch('/check_frame/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ get_instruction: true })
            });
            const data = await response.json();
            currentNonce = data.nonce;
            expiresAt = new Date(data.expires);
            {#instructionDiv.textContent = data.instruction || "دستور موجود نیست";#}
            instructionOverlay.textContent = data.instruction || "دستور موجود نیست";
            return data.instruction;
        } catch (err) {
            console.error("Error fetching instruction:", err);
            {#instructionDiv.textContent = "خطا در بارگذاری دستور";#}
            instructionOverlay.textContent = "خطا در بارگذاری دستور";
            return null;
        }
    }

    // Send frames periodically
    function startSendingFrames() {
        let frameIndex = 0;

        intervalId = setInterval(async () => {
            if (!video.videoWidth || !video.videoHeight) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const imgData = canvas.toDataURL('image/jpeg');

            const payload = {
                image: imgData,
                nonce: currentNonce,
                client_time: new Date().toISOString(),
                frame_index: frameIndex++,
            };
            try {
                const resp = await fetch('/check_frame/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const resData = await resp.json();

                if (resData.status && resData.status !== "Processing...") {
                    challengeStatus.textContent = resData.status.includes("Alive") ? "موفق" : "ناموفق";
                    if (resData.status.includes("Alive")) {
                        showResult("✅ چالش با موفقیت انجام شد", "success");
                        stopLiveness();
                    } else {
                        stopLiveness();
                        showResult("⚠️ چالش انجام نشد، لطفا دوباره تلاش کنید", "error");
                    }
                } else {
                    challengeStatus.textContent = "در حال پردازش...";
                    showResult("در حال تشخیص زنده‌بودن... لطفا دستور را دنبال کنید", "processing");
                }

                if (resData.error) {
                    challengeStatus.textContent = resData.error || 'error';
                    showResult(resData.error, "error");
                    stopLiveness(resData.error);
                }

                const progress = Math.min(100, Math.max(0, 100 - (remainingTime * 10)));
                progressStatus.textContent = `${progress}%`;

                if (resData.new_instruction) instructionOverlay.textContent = resData.new_instruction;
                if (resData.instruction) instructionOverlay.textContent = resData.instruction;
            } catch (err) {
                console.error("Error sending frame:", err);
                showResult("خطا در ارسال داده به سرور", "error");
            }
        }, 300);
    }

    // Start button
    startBtn.addEventListener('click', async () => {
        startBtn.disabled = true;
        resetBtn.disabled = false;

        const webcamStarted = await startWebcam();
        if (!webcamStarted) {
            startBtn.disabled = false;
            return;
        }

        const instruction = await getInstruction();
        if (!instruction) {
            startBtn.disabled = false;
            return;
        }

        remainingTime = 10;
        updateCountdown();
        countdownInterval = setInterval(updateCountdown, 1000);
        startSendingFrames();
    });

    // Reset button
    resetBtn.addEventListener('click', () => {
        stopLiveness();
        getInstruction();
        resultContainer.innerHTML = "";
    });
</script>
</body>
</html>
